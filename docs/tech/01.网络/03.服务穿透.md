---
title: 内网穿透
date: 2022-08-30 19:47:32
permalink: /tech/net/forward/
article: false
---

# 内网穿透、反向代理、端口转发

> 这个功能其实考虑了很久，我在思考：对于一些已有的功能和工具，如果能够满足需求的话，为什么要重新写一套呢？

因此，

## 内网穿透

先聊一下什么是内网穿透。

> 内网穿透是一种技术，它允许从互联网上的设备访问位于内网（例如家庭或企业网络）中的服务或设备。通常，内网中的设备对互联网上的其他设备不可见，因为它们是通过NAT（网络地址转换）和防火墙保护的。内网穿透技术通过在内网设备和外部服务器之间建立一个通信隧道来克服这个限制。
> 这个通信隧道允许外部设备通过这个设立好的连接来访问内网中的服务，好像它们直接连接到互联网一样。这对于需要远程访问内部网络资源的场景特别有用，比如远程办公、家庭自动化、远程监控系统等。
> (From ChatGPT)

简单的总结一下就是, 对于被封闭在 NAT 后面的服务（如没有公网 IP 的家庭主机）, 可以通过建立起独立的通信信道来实现远程访问内部的网络资源（如
ssh、rdp 等服务）

内网穿透可以通过多种方式实现， 如：

+ 反向代理
+ VPN，实际上也是一种内网穿透的手段。
+ ...

目前大部分的实现都是基于反向代理做的端口转发来实现的，后面将详细分析常见的产品实现代码。

## 反向代理

> 看到一个很好的总结：
> 正向代理中，proxy和client同属一个lan，对server透明
> 反向代理中，proxy和server同属一个lan，对server透明

### 前情提要

抛开已有的产品实现以及之前的一些思路，现在我们的场景是：如何通过云函数来做一个内网穿透工具？

在搭建虚拟机测试时，如果连接的网络需要 802.1x 认证，此时如果每台虚拟机都去配置这个认证的话，将会非常的麻烦（不同 os 配置不同）。

因此，我们在虚拟机上实现了一个简易的 NAT 转发功能：802.1x 证书认证在 pve 物理机上进行配置，然后通过 iptables 实现一条 NAT rules: 将来源于 192.168.1.1/24 (内部网络) 的流量全部转发到认证的网卡上。

由此，所有的虚拟机都可以通过物理机访问外部网络了，这也是常见的家庭网络基础 NAT 模式。

但是这样的配置也出现了一个问题：虚拟机可以出，但是无法对外提供服务，因为提供的服务 IP 都是这内部 192 网段，外部机器没有访问到这个网络的方法。

我常用的方式便是，通过 nginx 在物理机上部署一个反向代理，通过 stream 快速暴露内部服务；这便是反向代理的基础场景。

### 原理实现

那我们该如何实现一个



## 端口转发


## 参考链接

> https://www.cnblogs.com/paidx0/p/13975124.html